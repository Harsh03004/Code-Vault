<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Code Vault</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .dashboard-container {
      max-width: 1000px;
      margin: 40px auto;
      padding: 30px;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .dashboard-header h1 {
      color: #00f6ff;
      font-size: 2rem;
    }

    .search-bar {
      padding: 10px 15px;
      border-radius: 6px;
      border: 1px solid #2a2d35;
      background: #1f222a;
      color: #e0e0e0;
      width: 300px;
      font-size: 1rem;
    }

    .search-bar:focus {
      outline: 2px solid #00f6ff;
    }

    .snippets-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .snippet-card {
      background: #14161c;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0, 246, 255, 0.2);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .snippet-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 20px rgba(0, 246, 255, 0.4);
    }

    .snippet-card h3 {
      color: #00f6ff;
      margin-bottom: 10px;
      font-size: 1.2rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .snippet-meta {
      color: #888;
      font-size: 0.85rem;
      margin-bottom: 15px;
    }

    .snippet-preview {
      background: #0f1117;
      padding: 10px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      color: #e0e0e0;
      max-height: 100px;
      overflow: hidden;
      margin-bottom: 15px;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .snippet-actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      font-size: 0.9rem;
      transition: transform 0.2s;
      flex: 1;
    }

    .btn:hover {
      transform: scale(1.05);
    }

    .btn-primary {
      background: linear-gradient(90deg, #00f6ff, #4fd1c5);
      color: #0f1117;
    }

    .btn-danger {
      background: #ff4d4d;
      color: white;
    }

    .btn-new {
      background: linear-gradient(90deg, #00f6ff, #4fd1c5);
      color: #0f1117;
      padding: 12px 24px;
      font-size: 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 0 15px rgba(0, 246, 255, 0.3);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #888;
    }

    .empty-state h2 {
      color: #00f6ff;
      margin-bottom: 15px;
    }

    .empty-state p {
      margin-bottom: 25px;
      font-size: 1.1rem;
    }
  </style>
</head>
<body>
  <!-- Top Navbar -->
  <nav class="navbar">
    <div class="logo">Code Vault</div>
    <div class="nav-links">
      <button class="active">Dashboard</button>
      <button onclick="window.location.href='index.html'">Vault</button>
      <button onclick="window.location.href='profile.html'">Profile</button>
    </div>
  </nav>

  <div class="dashboard-container">
    <div class="dashboard-header">
      <h1>My Code Snippets</h1>
      <input type="text" class="search-bar" id="searchInput" placeholder="Search snippets..." onkeyup="filterSnippets()" />
    </div>

    <div id="snippetsContainer" class="snippets-grid"></div>

    <div style="text-align: center; margin-top: 30px;">
      <button class="btn-new" onclick="createNewSnippet()">+ New Snippet</button>
    </div>
  </div>

  <!-- Decrypt Password Modal -->
  <div id="decryptModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: #14161c; padding: 30px; border-radius: 12px; box-shadow: 0 0 30px rgba(0, 246, 255, 0.5); max-width: 400px; width: 90%;">
      <h2 style="color: #00f6ff; margin-bottom: 20px;">ðŸ”“ Decrypt Snippet</h2>
      <p style="color: #e0e0e0; margin-bottom: 15px;" id="decryptSnippetName"></p>
      <input type="password" id="decryptPasswordInput" placeholder="Enter decryption password..." style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #2a2d35; background: #1f222a; color: #e0e0e0; font-size: 1rem; margin-bottom: 20px;" />
      <div style="display: flex; gap: 10px;">
        <button onclick="closeDecryptModal()" style="flex: 1; padding: 10px; border: none; border-radius: 6px; background: #2a2d35; color: #e0e0e0; cursor: pointer; font-weight: bold;">Cancel</button>
        <button onclick="confirmDecryptDashboard()" style="flex: 1; padding: 10px; border: none; border-radius: 6px; background: linear-gradient(90deg, #00f6ff, #4fd1c5); color: #0f1117; cursor: pointer; font-weight: bold;">Decrypt</button>
      </div>
      <div id="decryptError" style="color: #ff4d4d; margin-top: 15px; font-size: 0.9rem; display: none;"></div>
    </div>
  </div>

  <script>
    const BASE_URL = 'http://localhost:3000/api';
    let allSnippets = [];
    let currentDecryptSnippet = null;
    let decryptedPasswords = {}; // Store passwords for re-encryption

    // Check authentication
    const accessToken = localStorage.getItem('accessToken');
    if (!accessToken) {
      window.location.href = 'login.html';
    }

    // Load snippets
    async function loadSnippets() {
      try {
        const res = await fetch(`${BASE_URL}/snippets`, {
          headers: {
            'Authorization': `Bearer ${accessToken}`
          }
        });

        const data = await res.json();

        if (!res.ok || !data.success) {
          throw new Error(data.message || 'Failed to load snippets');
        }

        allSnippets = data.data;
        displaySnippets(allSnippets);
      } catch (err) {
        console.error('Load snippets error:', err);
        document.getElementById('snippetsContainer').innerHTML = `
          <div class="empty-state">
            <h2>Error Loading Snippets</h2>
            <p>${err.message}</p>
          </div>
        `;
      }
    }

    // Display snippets
    function displaySnippets(snippets) {
      const container = document.getElementById('snippetsContainer');

      if (snippets.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h2>No Snippets Yet</h2>
            <p>Start creating your first code snippet!</p>
            <button class="btn-new" onclick="createNewSnippet()">+ Create First Snippet</button>
          </div>
        `;
        return;
      }

      container.innerHTML = snippets.map(snippet => `
        <div class="snippet-card" id="card-${snippet._id}">
          <h3>${snippet.isEncrypted ? 'ðŸ”’' : 'ðŸ“„'} ${escapeHtml(snippet.name)}</h3>
          <div class="snippet-meta">
            Created: ${formatDate(snippet.createdAt)}${snippet.isEncrypted ? ' â€¢ Encrypted' : ''}
          </div>
          <div class="snippet-preview" id="preview-${snippet._id}">
            ${snippet.isEncrypted 
              ? `<div style="text-align: center; padding: 20px; color: #888;">
                   <div style="font-size: 3rem; margin-bottom: 10px;">ðŸ”’</div>
                   <p style="color: #00f6ff;">This snippet is encrypted</p>
                   <p style="font-size: 0.85rem; margin-top: 5px;">Click Open to decrypt and view</p>
                 </div>` 
              : escapeHtml(snippet.code.substring(0, 150)) + (snippet.code.length > 150 ? '...' : '')}
          </div>
          <div class="snippet-actions">
            <button class="btn btn-primary" onclick="${snippet.isEncrypted ? `decryptSnippetInDashboard(\`${snippet._id}\`, \`${escapeHtml(snippet.name)}\`)` : `openSnippet(\`${snippet._id}\`)`}">Open</button>
            <button class="btn btn-danger" onclick="deleteSnippet(\`${snippet._id}\`, \`${escapeHtml(snippet.name)}\`)">Delete</button>
          </div>
        </div>
      `).join('');
    }

    // Filter snippets
    function filterSnippets() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const filtered = allSnippets.filter(snippet => 
        snippet.name.toLowerCase().includes(searchTerm) ||
        snippet.code.toLowerCase().includes(searchTerm)
      );
      displaySnippets(filtered);
    }

    // Open snippet
    function openSnippet(id) {
      localStorage.setItem('loadSnippetId', id);
      window.location.href = 'index.html';
    }

    // Delete snippet
    async function deleteSnippet(id, name) {
      if (!confirm(`Are you sure you want to delete "${name}"?`)) {
        return;
      }

      try {
        const res = await fetch(`${BASE_URL}/snippets/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${accessToken}`
          }
        });

        const data = await res.json();

        if (!res.ok || !data.success) {
          throw new Error(data.message || 'Failed to delete snippet');
        }

        // Clear from localStorage if it was the loaded snippet
        const loadedSnippetId = localStorage.getItem('currentSnippetId');
        if (loadedSnippetId === id) {
          localStorage.removeItem('currentSnippetId');
        }

        // Show success message
        alert('Snippet deleted successfully!');

        // Reload snippets
        loadSnippets();
      } catch (err) {
        console.error('Delete snippet error:', err);
        alert('Error: ' + err.message);
      }
    }

    // Create new snippet
    function createNewSnippet() {
      localStorage.removeItem('loadSnippetId');
      window.location.href = 'index.html';
    }

    // Format date
    function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

      if (diffDays === 0) return 'Today';
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return `${diffDays} days ago`;
      
      return date.toLocaleDateString();
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Decrypt snippet in dashboard - ask for password then open
    function decryptSnippetInDashboard(id, name) {
      currentDecryptSnippet = allSnippets.find(s => s._id === id);
      if (!currentDecryptSnippet) {
        alert('Snippet not found');
        return;
      }
      
      document.getElementById('decryptSnippetName').textContent = `Enter password to open: ${name}`;
      document.getElementById('decryptModal').style.display = 'flex';
      document.getElementById('decryptPasswordInput').value = '';
      document.getElementById('decryptPasswordInput').focus();
      document.getElementById('decryptError').style.display = 'none';
    }

    // Close decrypt modal
    function closeDecryptModal() {
      document.getElementById('decryptModal').style.display = 'none';
      document.getElementById('decryptPasswordInput').value = '';
      document.getElementById('decryptError').style.display = 'none';
      currentDecryptSnippet = null;
    }

    // Confirm decrypt and open in editor
    function confirmDecryptDashboard() {
      const password = document.getElementById('decryptPasswordInput').value;
      const errorEl = document.getElementById('decryptError');

      if (!password) {
        errorEl.textContent = 'Please enter the decryption password';
        errorEl.style.display = 'block';
        return;
      }

      if (!currentDecryptSnippet) {
        errorEl.textContent = 'No snippet to decrypt';
        errorEl.style.display = 'block';
        return;
      }

      // Store the password temporarily for the editor to use
      sessionStorage.setItem('decryptPassword', password);
      sessionStorage.setItem('needsDecryption', 'true');
      
      // Navigate to editor with the snippet
      localStorage.setItem('loadSnippetId', currentDecryptSnippet._id);
      window.location.href = 'index.html';
    }

    // Handle Enter key in decrypt modal
    document.addEventListener('DOMContentLoaded', () => {
      const decryptInput = document.getElementById('decryptPasswordInput');
      if (decryptInput) {
        decryptInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            confirmDecryptDashboard();
          }
        });
      }
    });

    // Load snippets on page load
    loadSnippets();
  </script>
</body>
</html>
